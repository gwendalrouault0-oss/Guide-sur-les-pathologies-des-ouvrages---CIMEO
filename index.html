<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIMEO Normandie - Diagnostic Structures IA</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    <style>
        /* === Styles inchang√©s === */
        * {margin:0;padding:0;box-sizing:border-box;}
        :root {
            --cimeo-orange:#FF6B35;--cimeo-blue:#1E3A8A;--cimeo-black:#1F2937;
            --cimeo-white:#FFFFFF;--cimeo-gray:#F8FAFC;--cimeo-light-gray:#E2E8F0;
        }
        body{font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            background:linear-gradient(135deg,var(--cimeo-blue)0%,var(--cimeo-black)100%);
            min-height:100vh;color:var(--cimeo-black);}
        .header{background:var(--cimeo-white);box-shadow:0 4px 20px rgba(0,0,0,0.1);
            padding:20px;text-align:center;margin-bottom:30px;}
        .logo{display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:10px;}
        .logo-icon{width:50px;height:50px;background:linear-gradient(45deg,var(--cimeo-orange),#FF8C42);
            border-radius:12px;display:flex;align-items:center;justify-content:center;
            font-size:24px;color:var(--cimeo-white);font-weight:bold;}
        .company-name{font-size:2.5rem;font-weight:700;color:var(--cimeo-blue);letter-spacing:-0.5px;}
        .company-tagline{color:var(--cimeo-black);font-size:1.1rem;opacity:0.8;margin-top:5px;}
        .container{max-width:900px;margin:0 auto;padding:0 20px;}
        .main-card{background:var(--cimeo-white);border-radius:20px;padding:40px;
            box-shadow:0 20px 40px rgba(0,0,0,0.15);margin-bottom:30px;}
        .section-title{color:var(--cimeo-blue);font-size:1.5rem;font-weight:600;text-align:center;margin-bottom:30px;}
        .camera-section{text-align:center;margin-bottom:30px;}
        #webcam{width:100%;max-width:640px;height:auto;border-radius:15px;
            border:3px solid var(--cimeo-orange);box-shadow:0 8px 25px rgba(255,107,53,0.2);
            margin-bottom:20px;background:var(--cimeo-gray);}
        #snapshot{display:none;}
        .upload-area{border:3px dashed var(--cimeo-orange);border-radius:15px;padding:40px;text-align:center;
            margin:20px 0;background:var(--cimeo-gray);transition:all 0.3s ease;display:none;cursor:pointer;color:var(--cimeo-black);}
        .upload-area.show{display:block;}
        .upload-area:hover{border-color:var(--cimeo-blue);background:#EBF4FF;transform:translateY(-2px);}
        .upload-area.dragover{border-color:var(--cimeo-blue);background:#EBF4FF;transform:scale(1.02);}
        .upload-area h3{color:var(--cimeo-blue);margin-bottom:10px;font-size:1.3rem;}
        .uploaded-image{max-width:100%;max-height:400px;border-radius:15px;border:3px solid var(--cimeo-orange);
            margin:20px 0;box-shadow:0 8px 25px rgba(255,107,53,0.2);display:none;}
        .controls{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin:30px 0;}
        button{padding:14px 28px;font-size:16px;font-weight:600;border:none;border-radius:50px;
            cursor:pointer;transition:all 0.3s ease;min-width:160px;position:relative;overflow:hidden;}
        button:before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;}
        button:hover:before{left:100%;}
        .btn-primary{background:linear-gradient(45deg,var(--cimeo-orange),#FF8C42);
            color:var(--cimeo-white);box-shadow:0 4px 15px rgba(255,107,53,0.3);}
        .btn-primary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 25px rgba(255,107,53,0.4);}
        .btn-secondary{background:linear-gradient(45deg,var(--cimeo-blue),#3B82F6);
            color:var(--cimeo-white);box-shadow:0 4px 15px rgba(30,58,138,0.3);}
        .btn-secondary:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(30,58,138,0.4);}
        .btn-outline{background:var(--cimeo-white);color:var(--cimeo-black);
            border:2px solid var(--cimeo-light-gray);box-shadow:0 4px 15px rgba(0,0,0,0.1);}
        .btn-outline:hover{background:var(--cimeo-gray);transform:translateY(-3px);}
        button:disabled{opacity:0.6;cursor:not-allowed;transform:none!important;}
        .status{text-align:center;margin:25px 0;padding:20px;border-radius:15px;font-weight:500;font-size:16px;}
        .status.loading{background:#EBF4FF;color:var(--cimeo-blue);border:2px solid #BFDBFE;}
        .status.ready{background:#ECFDF5;color:#059669;border:2px solid #A7F3D0;}
        .status.error{background:#FEF2F2;color:#DC2626;border:2px solid #FECACA;}
        .result-section{margin-top:40px;padding:30px;border-radius:20px;
            background:linear-gradient(135deg,var(--cimeo-gray)0%,var(--cimeo-white)100%);
            border:2px solid var(--cimeo-light-gray);display:none;}
        .result-section.show{display:block;animation:slideIn 0.6s ease-out;}
        @keyframes slideIn{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
        .result-header{text-align:center;margin-bottom:25px;}
        .prediction{font-size:1.8rem;font-weight:bold;margin-bottom:15px;text-align:center;}
        .prediction.safe{color:#059669;}
        .prediction.danger{color:#DC2626;}
        .confidence{text-align:center;font-size:1.1rem;color:var(--cimeo-black);opacity:0.8;
            margin-bottom:25px;white-space:pre-line;}
        .action-buttons{display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin-top:25px;}
        .pdf-link{padding:14px 28px;background:linear-gradient(45deg,#DC2626,#EF4444);
            color:var(--cimeo-white);text-decoration:none;border-radius:50px;font-weight:600;
            transition:all 0.3s ease;box-shadow:0 4px 15px rgba(220,38,38,0.3);}
        .pdf-link:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(220,38,38,0.4);}
        .new-analysis-btn{background:linear-gradient(45deg,var(--cimeo-blue),#3B82F6);
            color:var(--cimeo-white);border:none;padding:14px 28px;border-radius:50px;font-weight:600;
            cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(30,58,138,0.3);}
        .new-analysis-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(30,58,138,0.4);}
        .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;
            border-top:3px solid var(--cimeo-orange);border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .footer{background:var(--cimeo-white);margin-top:50px;padding:30px 20px;text-align:center;
            color:var(--cimeo-black);opacity:0.8;border-top:1px solid var(--cimeo-light-gray);}
        .footer-content{max-width:800px;margin:0 auto;}
        .tech-stack{display:flex;justify-content:center;gap:20px;margin-top:15px;flex-wrap:wrap;}
        .tech-badge{background:var(--cimeo-gray);padding:8px 16px;border-radius:20px;font-size:0.9rem;
            color:var(--cimeo-black);border:1px solid var(--cimeo-light-gray);}
        @media (max-width:768px){
            .company-name{font-size:2rem;}
            .main-card{padding:25px;margin:0 10px;}
            .controls{flex-direction:column;align-items:center;}
            button{width:100%;max-width:250px;}
            .action-buttons{flex-direction:column;align-items:center;}
            .pdf-link,.new-analysis-btn{width:100%;max-width:250px;text-align:center;}
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">C</div>
            <div>
                <div class="company-name">CIMEO Normandie</div>
                <div class="company-tagline">Diagnostic de structures par Intelligence Artificielle</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-card">
            <h2 class="section-title">üîç Analyse de Fissures Structurelles</h2>
            
            <div class="camera-section">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="snapshot"></canvas>
                
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: var(--cimeo-orange);">üìÅ</div>
                    <h3>D√©posez une image ici ou cliquez pour s√©lectionner</h3>
                    <p style="margin-top: 10px; opacity: 0.7;">Formats accept√©s: JPG, PNG, WebP (max 10MB)</p>
                </div>
                
                <img id="uploadedImage" class="uploaded-image" alt="Image t√©l√©charg√©e">
                
                <div class="controls">
                    <button id="capture" class="btn-primary" disabled>üì∏ Analyser avec cam√©ra</button>
                    <button id="uploadBtn" class="btn-secondary">üìÅ Analyser une image</button>
                    <button id="switchCamera" class="btn-outline">üîÑ Changer cam√©ra</button>
                    <input type="file" id="fileInput" accept="image/*" style="display:none;">
                </div>
            </div>

            <div id="status" class="status loading">
                <span class="loading-spinner"></span>
                Initialisation du syst√®me IA...
            </div>

            <div id="result" class="result-section">
                <div class="result-header">
                    <div id="prediction" class="prediction"></div>
                    <div id="confidence" class="confidence"></div>
                </div>
                
                <div class="action-buttons">
                    <a href="#" id="pdfLink" class="pdf-link" target="_blank" style="display:none;">
                        ‚ö†Ô∏è T√©l√©charger le protocole d'intervention
                    </a>
                    <button id="newAnalysisBtn" class="new-analysis-btn">üîÑ Nouvelle analyse</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <p><strong>CIMEO Normandie</strong> - Solutions innovantes de diagnostic structurel</p>
            <div class="tech-stack">
                <span class="tech-badge">TensorFlow.js</span>
                <span class="tech-badge">Teachable Machine</span>
                <span class="tech-badge">Intelligence Artificielle</span>
                <span class="tech-badge">Diagnostic Temps R√©el</span>
            </div>
            <p style="margin-top:15px;font-size:0.9rem;">¬© 2024 - Technologie de pointe pour l'analyse structurelle</p>
        </div>
    </div>

    <script>
        let model, webcam, canvas, ctx;
        let currentFacingMode = 'user';
        let stream = null;

        // ‚úÖ Chemin du PDF corrig√©
        const config = {
            classes: ["Structure saine", "Fissure d√©tect√©e"],
            pdfs: [
                null,
                "pdf/Fissuration.pdf" // <‚îÄ‚îÄ place ton fichier ici: /pdf/Fissuration.pdf
            ]
        };

        const elements = {
            webcam: document.getElementById('webcam'),
            canvas: document.getElementById('snapshot'),
            captureBtn: document.getElementById('capture'),
            uploadBtn: document.getElementById('uploadBtn'),
            switchBtn: document.getElementById('switchCamera'),
            fileInput: document.getElementById('fileInput'),
            uploadArea: document.getElementById('uploadArea'),
            uploadedImage: document.getElementById('uploadedImage'),
            status: document.getElementById('status'),
            result: document.getElementById('result'),
            prediction: document.getElementById('prediction'),
            confidence: document.getElementById('confidence'),
            pdfLink: document.getElementById('pdfLink'),
            newAnalysisBtn: document.getElementById('newAnalysisBtn')
        };

        async function init(){
            try{
                updateStatus('loading','V√©rification des composants IA...');
                if(typeof tf==='undefined') throw new Error('TensorFlow.js non disponible');
                updateStatus('loading','Chargement du mod√®le de d√©tection...');
                await loadTeachableMachineModel();
                updateStatus('loading','Configuration de la cam√©ra...');
                await setupWebcam();
                updateStatus('ready',"‚úÖ Syst√®me pr√™t ! S√©lectionnez votre m√©thode d'analyse.");
            }catch(e){console.error(e);updateStatus('error','‚ùå '+e.message);}
        }

        async function loadTeachableMachineModel(){
            const modelURL='https://teachablemachine.withgoogle.com/models/rVulDxd6m/';
            model=await tmImage.load(modelURL+'model.json',modelURL+'metadata.json');
            const classLabels=model.getClassLabels();
            if(classLabels&&classLabels.length>0) config.classes=classLabels;
        }

        async function setupWebcam(){
            canvas=elements.canvas;webcam=elements.webcam;ctx=canvas.getContext('2d');
            const streamData=await navigator.mediaDevices.getUserMedia({video:true});
            webcam.srcObject=streamData;
            await webcam.play();
            canvas.width=webcam.videoWidth;canvas.height=webcam.videoHeight;
            elements.captureBtn.disabled=false;
        }

        async function analyzeImage(source='camera'){
            let srcElem=source==='camera'?webcam:elements.uploadedImage;
            canvas.width=srcElem.naturalWidth||srcElem.videoWidth;
            canvas.height=srcElem.naturalHeight||srcElem.videoHeight;
            ctx.drawImage(srcElem,0,0,canvas.width,canvas.height);
            const predictions=await model.predict(canvas);
            let maxIndex=0,maxProb=0;
            predictions.forEach((p,i)=>{if(p.probability>maxProb){maxProb=p.probability;maxIndex=i;}});
            displayResults(maxIndex,maxProb,predictions);
        }

        function displayResults(classIndex,confidence,allPred){
            const className=config.classes[classIndex];
            const isCrack=classIndex===1;
            elements.prediction.textContent=className;
            elements.prediction.className=isCrack?'prediction danger':'prediction safe';
            elements.confidence.textContent=`Niveau de confiance: ${(confidence*100).toFixed(1)}%`;
            if(isCrack && config.pdfs[classIndex]){
                elements.pdfLink.href=config.pdfs[classIndex];
                elements.pdfLink.style.display='inline-block';
            } else {
                elements.pdfLink.style.display='none';
            }
            elements.result.classList.add('show');
            updateStatus(isCrack?'error':'ready',
                isCrack?'‚ö†Ô∏è Fissure d√©tect√©e ! Consultez le protocole.':'‚úÖ Structure saine.');
        }

        function updateStatus(type,msg){
            elements.status.className=`status ${type}`;
            elements.status.innerHTML=type==='loading'?`<span class="loading-spinner"></span>${msg}`:msg;
        }

        // Upload
        elements.uploadBtn.addEventListener('click',()=>{
            if(elements.uploadedImage.style.display==='block'){analyzeImage('upload');}
            else{elements.fileInput.click();}
        });
        elements.fileInput.addEventListener('change',e=>{
            if(e.target.files.length>0){
                const f=e.target.files[0];
                const r=new FileReader();
                r.onload=ev=>{
                    elements.uploadedImage.src=ev.target.result;
                    elements.uploadedImage.style.display='block';
                    updateStatus('ready','‚úÖ Image charg√©e ! Cliquez sur "Analyser".');
                };
                r.readAsDataURL(f);
            }
        });

        elements.captureBtn.addEventListener('click',()=>analyzeImage('camera'));
        elements.newAnalysisBtn.addEventListener('click',()=>{elements.result.classList.remove('show');updateStatus('ready','Pr√™t pour une nouvelle analyse.');});

        init();
    </script>
</body>
</html>
